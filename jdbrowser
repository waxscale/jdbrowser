#!/home/jaguar/.pyenv/versions/jdbrowser/bin/python

import sys
import os
import configparser
from PySide6 import QtCore, QtGui, QtWidgets

class FileBrowser(QtWidgets.QMainWindow):
    def __init__(self, directory):
        super().__init__()
        self.directory = directory
        self.setWindowTitle(f"File Browser - {self.directory}")
        self._setup_ui()
        self._setup_shortcuts()

    def _setup_ui(self):
        # Scrollable area
        scroll = QtWidgets.QScrollArea()
        scroll.setWidgetResizable(True)
        container = QtWidgets.QWidget()
        mainLayout = QtWidgets.QVBoxLayout(container)
        mainLayout.setSpacing(10)
        mainLayout.setContentsMargins(5, 5, 5, 5)

        cols = 5
        row = 0
        col = 0
        sectionGrid = QtWidgets.QGridLayout()
        sectionGrid.setSpacing(5)
        sectionGrid.setContentsMargins(0, 0, 0, 0)

        entries = sorted(os.listdir(self.directory), key=lambda x: x.lower())
        for name in entries:
            if name.lower().endswith('.2do'):
                # Add previous section, left-aligned
                mainLayout.addLayout(sectionGrid)
                mainLayout.setAlignment(sectionGrid, QtCore.Qt.AlignmentFlag.AlignLeft)
                # Header
                header_text = os.path.splitext(name)[0]
                header = QtWidgets.QLabel(header_text)
                header.setAlignment(
                    QtCore.Qt.AlignmentFlag.AlignLeft | QtCore.Qt.AlignmentFlag.AlignVCenter
                )
                font = header.font()
                font.setPointSize(int(font.pointSize() * 1.5))
                font.setBold(True)
                header.setFont(font)
                header.setStyleSheet(
                    "background-color: #d7ba7d; color: black; padding-left:5px; padding-right:5px;"
                )
                fm = header.fontMetrics()
                header.setFixedHeight(fm.height() + 6)  # font height + 6px vertical padding
                mainLayout.addWidget(header)
                # New section grid
                sectionGrid = QtWidgets.QGridLayout()
                sectionGrid.setSpacing(5)
                sectionGrid.setContentsMargins(0, 0, 0, 0)
                row = 0
                col = 0
                continue

            # Icon placeholder
            icon = QtWidgets.QFrame()
            icon.setFixedSize(240, 150)
            icon.setStyleSheet(
                "background-color: #2e303e; border-radius: 10px;"
            )
            # Filename label
            label = QtWidgets.QLabel(name)
            label.setAlignment(QtCore.Qt.AlignmentFlag.AlignHCenter)
            label.setFixedWidth(240)
            label.setWordWrap(True)
            label.setStyleSheet("color: #c0caf5;")

            # Item container
            item = QtWidgets.QWidget()
            vbox = QtWidgets.QVBoxLayout(item)
            vbox.setSpacing(2)
            vbox.setContentsMargins(0, 0, 0, 0)
            vbox.addWidget(icon, alignment=QtCore.Qt.AlignmentFlag.AlignHCenter)
            vbox.addWidget(label, alignment=QtCore.Qt.AlignmentFlag.AlignHCenter)

            sectionGrid.addWidget(item, row, col)
            col += 1
            if col >= cols:
                col = 0
                row += 1

        # Add final section
        mainLayout.addLayout(sectionGrid)
        mainLayout.setAlignment(sectionGrid, QtCore.Qt.AlignmentFlag.AlignLeft)

        container.setStyleSheet("background-color: #000000;")
        scroll.setWidget(container)
        self.setCentralWidget(scroll)

        # Global styles
        style = """
        * { font-family: 'FiraCode Nerd Font'; }
        QWidget { background-color: #000000; }
        QMainWindow { background-color: #000000; }
        QScrollArea { border: none; background-color: #000000; }
        QScrollBar:vertical {
            width: 8px;
            background: #000000;
        }
        QScrollBar::handle:vertical {
            background: #44475a;
            min-height: 20px;
            border-radius: 4px;
        }
        QScrollBar::add-line, QScrollBar::sub-line {
            height: 0;
        }
        QScrollBar::add-page, QScrollBar::sub-page {
            background: none;
        }
        """
        self.setStyleSheet(style)

    def _setup_shortcuts(self):
        for seq in ["Q", "Ctrl+Q", "Ctrl+W", "Esc", "Alt+F4"]:
            shortcut = QtGui.QShortcut(QtGui.QKeySequence(seq), self)
            shortcut.activated.connect(self.close)


def read_config():
    config = configparser.ConfigParser()
    cfg_path = os.path.expanduser("~/.config/jdbrowser/config.conf")
    config.read(cfg_path)
    return config.get("settings", "repository", fallback=os.getcwd())

if __name__ == "__main__":
    if len(sys.argv) > 1:
        directory = sys.argv[1]
    else:
        directory = read_config()
    directory = os.path.expanduser(directory)
    if not os.path.isdir(directory):
        print("Error:", directory, "is not a valid directory.")
        sys.exit(1)

    app = QtWidgets.QApplication(sys.argv)
    app.setFont(QtGui.QFont("FiraCode Nerd Font"))
    browser = FileBrowser(directory)
    browser.resize(1000, 600)
    browser.show()
    sys.exit(app.exec())
